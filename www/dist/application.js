/**
 * Pixel. Run. Namics. (Build HkS2rOs)
 * @author Jan Biasi <jan.biasi@namics.com>
 * @version v1.5.0-alpha
 * @license MIT Licensed by Namics AG
 * @see http://namics.com/
 */

!function(t,n){"use strict";function e(t){this.name="GameError",this.message=t||"Undefined error"}function o(t,n){return this.input=t,this.data=n,this}function r(n){this.enabled=t.Container.settings.debug===!0,this.namespace=n||"undefined"}e.prototype=Error.prototype,t.GameError=e,Util.noop=function(){},Util.orderScore=function(t){function n(t,n){return t.score>n.score?-1:t.score<n.score?1:0}return t.sort(n)},Util["default"]=function(t,e,o){return"function"==typeof o?o(t)===!0?t:e:t&&t!==n&&null!==t?t:e},Util.clone=function(t){if(!t||"object"!=typeof t)return t;var n=t.constructor();for(var e in t)t.hasOwnProperty(e)&&"_saveState"!==e&&(n[e]=t[e]);return n},Util.hyphenate=function(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()},o.prototype={replace:function(t){var e=this.input;t===n&&(t=this.data);var o=Object.keys(t);return o.forEach(function(n){e=Util.replaceAll(e,"{"+n+"}",t[n])}),e}},Util.replace=function(t,n){return new o(t).replace(n)},Util.Replacer=o,r.prototype={warn:function(){console&&console.warn&&this.$out(arguments,function(t){console.warn.apply(console,t)})},info:function(){console&&console.info&&this.$out(arguments,function(t){console.info.apply(console,t)})},error:function(){console&&console.error&&this.$out(arguments,function(t){console.error.apply(console,t)})},log:function(){console&&this.$out(arguments,function(t){console.log.apply(console,t)})},"throw":function(t,n){throw new e(t+"("+n+")")},$out:function(t,n){var e=Array.prototype.slice.call(t);e.unshift("["+this.namespace+"]:"),n(e)}},Util.Debugger=r,Util.getValues=function(t){var n=[];for(var e in t)n.push(t[e]);return n},Util.getPlayerScoreData=function(){var t,n,e=[];for(n in Session)e.push(Session[n]);return t=Util.orderScore(e),{p1:t[0]?t[0].name:"-",p2:t[1]?t[1].name:"-",p3:t[2]?t[2].name:"-",p1s:t[0]?t[0].score:"-",p2s:t[1]?t[1].score:"-",p3s:t[2]?t[2].score:"-",p1img:t[0]?t[0].image():"",p2img:t[1]?t[1].image():"",p3img:t[2]?t[2].image():"",wtype:Container.settings.worldType}},Util.replaceAll=function(t,n,e){return t.replace(new RegExp(n,"g"),e)},Util.getScoreTable=function(t,n){var e=[];$.get("/api/get/scores",function(o){o.forEach(function(n){e.push("<tr><td>"),t.index&&(e.push("<strong>"),e.push("# "+n.index),e.push("</strong></td><td>")),e.push(n.score),e.push("</td><td>"),e.push(n.name),e.push("</td><td>"),e.push(Util.firstToUpper(n.world)),e.push("</td><tr>")}),n(e.join("\n"))})},Util.calculate={score:function(t){var n=t/100;return Math.round(n)}},Util.firstToUpper=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}}(window);
!function(e,r){"use strict";var o=e.Store,t=function(){};t.prototype={score:function(e,r,t){o.has("score")&&Array.isArray(o.get("score"))||this.resetScore();var c=o.get("score");c.push({holder:e,score:r,map:t}),o.set("score",c)},getHighscore:function(e){var r=this.$getScore()[0];return e?r:r.score},resetScore:function(){o.set("score",[])},$getScore:function(){return Util.orderScore(o.get("score"))}},Container.Store=new t}(window);
!function(e,t){"use strict";$(document).ready(function(){return 0===$("#js-fetch-scores").length?!1:(console.log("Refetch interval set to %ds in file /app/provider/settings.js",Container.settings.scores.refetch/1e3),void e.setInterval(function(){Container.settings.debug&&console.log("Refetching scores at %s",(new Date).toTimeString().split(" ")[0]),Util.getScoreTable({index:!0},function(e){$("#js-insert").html(e)})},Container.settings.scores.refetch||5e3))})}(window);
!function(t,e){"use strict";function i(t,e,i,s,a){return this.$baseSprite=n.settings.game.players.baseName,this.$basePath=n.settings.game.players.basePath+n.settings.worldType+"/",this.$mimeType=n.settings.game.players.mimeType,this.jumpOn=n.settings.game.jumpOn,this.id=e,this.type=a,this.jumpKey=n.settings.game.players.keymap[e],this.injector=t,this.doubleJump=!1,this.score=null,Phaser.Sprite.call(this,t,i,s,this.$getSpritesheet()),this.$addActionKey(),t.add.existing(this),o.log("New player initiaded on x/y ->",i,s),this}var s=20,o=new Util.Debugger("Player.class"),n=t.Container;i.prototype=Object.create(Phaser.Sprite.prototype),i.prototype.constructor=i,i.prototype.init=function(){this.injector.physics.arcade.enable(this),this.body.bounce.y=n.settings.game.players.bounce.y,this.body.gravity.y=n.settings.game.players.gravity.y,this.body.collideWorldBounds=!0,this.body.linearDamping=1},i.prototype.collide=function(t,e){this.injector.game.arcade.collide(this,t,e,null)},i.prototype.run=function(){this.body.velocity.x=n.settings.game.players.velocity.x},i.prototype.jump=function(){this.body.onFloor()&&(Container.Audio.jump.play(),this.body.velocity.y=n.settings.game.players.velocity.y)},i.prototype.die=function(){o.log("Player died with id ->",this.id);var t=Session[$index.session[this.id]];o.log("Updating player session ->",this.id),Container.Audio.die.play(),this.$updateText("dead"),t.score=this.score,this.dead=!0,this.kill()},i.prototype.$updateText=function(t){if(t!==e){o.log("Updating player text ->",this.id);var i=Session[$index.session[this.id]];i.text.option("extension","("+t+")"),i.text.$update()}},i.prototype.$addActionKey=function(){return o.log("Player created actionKey ->",this.jumpKey),this.$actionKey=Container.cursors[this.jumpKey],this.$actionKey},i.prototype.$update=function(){this.score=Util.calculate.score(this.x),this.y>=Container.settings.render.height-Container.settings.game.players.height-s&&this.die(),this.x<=Container.game.camera.view.x-70&&this.die();var t="push"===this.jumpOn?"isDown":"isUp";this.$actionKey[t]&&this.jump()},i.prototype.$getSpritesheet=function(){return this.type=this.type===e?"-"+n.settings.game.players.variations[this.id]:"",this.$baseSprite+n.settings.worldType+this.type},t.Factory.Player=i}(window);
!function(t,e){"use strict";function i(t,e,i){var s=o.settings.worldType;return this.template="{name}: {score} {extension}",this.injector=t,this.player=e,this.score=i||0,this.opts={extension:"",fontSize:"20px",fontFamily:"Arial",fill:o.settings.worlds[s].contrast||"#ffffff"},this}var s=new Util.Debugger("ScoreText.class"),o=t.Container;i.prototype={get:function(){return Util.replace(this.template,{name:this.player,score:this.score,extension:this.opts.extension})},set:function(t){this.score=t,this.$update()},increase:function(t){this.score=this.score+t,this.$update()},option:function(t,e){this.opts[t]=e},add:function(t,e,i){return t=t||0,e=e||0,this.$text=this.injector.add.text(t,e,this.get(),{font:this.opts.fontSize+" "+this.opts.fontFamily,fill:this.opts.fill}),this.$text.fixedToCamera=i||!1,i&&this.$text.cameraOffset.setTo(t,e),s.log("Text added with props x, y, fixed ->",t,e,i),this},$update:function(){this.$text.setText(this.get())}},t.Factory.ScoreText=i}(window);
!function(t,i){"use strict";function e(t,i,e){return this.$id=a++,this.injector=t,this.image=i,this.path=e,this.setScaleMinMax(1,1),this}var r=new Util.Debugger("Sprite.class"),o=t.Util,a=0;e.prototype=Object.create(Phaser.Sprite.prototype),e.prototype.constructor=e,e.prototype.load=function(t){return t=o["default"](t,this.path),this.injector.load.image(this.image,t),this},e.prototype.add=function(t,i){return r.log("Sprite mounted ->",this.image,t,i),t=o["default"](t,0),i=o["default"](i,0),this.$internal=this.injector.add.sprite(t,i,this.image),this.$internal},t.Factory.Sprite=e}(window);
!function(e,t){"use strict";function r(e,t){return this.name=t,this.injector=e,this.map=null,this.layers={},this}var a=new Util.Debugger("Tilemap.class");r.prototype=Object.create(Phaser.Tilemap.prototype),r.prototype.constructor=r,r.prototype.addImage=function(e,t){return a.log("Tilemap image added with asset ->",e,t),this.map.addTilesetImage(e,t)},r.prototype.addToGame=function(e){return e=e||this.game||null,this.map=e.add.tilemap(this.name),this.map},r.prototype.createLayer=function(e){a.log("Layer created ->",e);var t=this.map.createLayer(e);return this.layers[e]=t,this.layers[e]},r.prototype.setCollision=function(e,t,r){a.log("Collision set on layer with start/end ->",e,t,r);try{var i=this.map.setCollisionBetween(t,r,!0,e);return i}catch(o){throw new Error("Tilemap.setCollision faield: "+o.message)}},r.prototype.resize=function(e){try{this.layers[e].resizeWorld(),a.log("World resized to the layer ->",e)}catch(t){a["throw"]("Tilemap.resize failed: "+t.message,0)}},e.Factory.Tilemap=r}(window);
!function(a,t){"use strict";Container.Boot=function(){},Container.Boot.prototype={preload:function(){this.$loadWorldDependencies(),this.$loadAudioFX()},create:function(){var a=this;Container.$indicate.preload=function(){a.state.start("Preload")}},$loadWorldDependencies:function(){var a=this,t=Object.keys(Container.settings.worlds);t.forEach(function(t){a.load.tilemap("tilemap-"+t,"/public/assets/img/world/"+t+"/tilemap-"+t+".json",null,Phaser.Tilemap.TILED_JSON),a.load.image("background-"+t,"/public/assets/img/backgrounds/background-"+t+".png"),a.load.image("tile-"+t,"/public/assets/img/world/"+t+"/tiles/tile-"+t+".png"),a.load.image("avatar-"+t+"-consultant","/public/assets/img/avatars/"+t+"/avatar-"+t+"-consultant.png"),a.load.image("avatar-"+t+"-techie","/public/assets/img/avatars/"+t+"/avatar-"+t+"-techie.png"),a.load.image("avatar-"+t+"-designer","/public/assets/img/avatars/"+t+"/avatar-"+t+"-designer.png")})},$loadAudioFX:function(){var a=this,t=Container.settings.audio.fx;t.forEach(function(t){a.load.audio("fx-"+t,"/public/assets/audio/fx/"+t+".mp3")})}}}(window);
!function(t,i){"use strict";Container.Configure=function(){this.ready=!1,this.error=null,this.background=null},Container.Configure.prototype={preload:function(){this.physics.arcade.gravity.y=Container.settings.physics.arcadeGravity||200,this.ready=!0;try{this.physics.startSystem(Phaser.Physics.ARCADE)}catch(t){this.error=t}},create:function(){if(!this.ready)throw this.error;this.state.start("Game")},quit:function(){this.ready=!1}}}(window);
!function(e,r){"use strict";var n=500,t=300,a=new Util.Debugger("States.Game"),o=Container.settings,i=o.game;Container.Game=function(){},Container.Game.prototype={create:function(){var e=this;this.$createAudioFX(),this.$createBackground(),this.$createTilemap(),Container.cursors=this.input.keyboard.createCursorKeys(),this.$createScoreTexts(),this.$createPlayers(function(){e.camera.follow(e.$furthestPlayer().player)}),this.$applyEmergency()},update:function(){if(this.skipUpdateLoop)return!1;var e=this,r=e.$getAlivePlayers();if(e.camera.follow(e.$furthestPlayer().player),0===r.length&&!e.finished)return e.exit();1===r.length;for(var n in Session){var t=Session[n].player();Container.game.physics.arcade.collide(t,Container.World.tilemapLayer),Session[n].text.set(Util.calculate.score(t.x)),t.dead!==!0?(t.$update(),t.run()):t.$updateText()}},exit:function(){this.skipUpdateLoop=!0,Container.game.lockRender=!0,Container.game.state.start("Over",!0,!0,this)},$getAlivePlayers:function(){var e=[];return Container.World.players.forEach(function(r){r.alive===!0&&e.push(r)}),e},$furthestPlayer:function(){var e=Container.World.players[0],r=Container.World.players[0].x;return Container.World.players.forEach(function(n){n.x>r&&(r=n.x,e=n)}),{player:e,position:r}},$createAudioFX:function(){var e=this,r=o.audio.fx;r.forEach(function(r){Container.Audio[r]={node:e.add.audio("fx-"+r),play:function(){Container.Audio[r].node.restart()}}})},$createPlayerSession:function(e,r,n){var t=o.worlds,a=o.worldType;return $index.session[n]=e,Session[e]={id:n,name:r,username:e,color:t[a].colors[n],image:function(){return Container.World.players[n].key+".png"},player:function(){return Container.World.players[n]}},Session[e]},$createScoreTexts:function(){var e=this,r=0,n=o.currentPlayers;n.forEach(function(n){n=n.trim();var t=n.replace(" ","");e.$createPlayerSession(t,n,r);var a=new Factory.ScoreText(e,t.toUpperCase(),0);a.option("fontSize",o.render.fontSize+"px"),a.option("fill",Session[t].color),a.add(20,(o.render.fontSize+5)*(r+1),!0),Session[t].text=a,r++})},$createBackground:function(){var e=new Factory.Sprite(this,"background-"+o.worldType);Container.World.background=e,e.setScaleMinMax(1,1,1,1),e.add(0,0)},$createTilemap:function(){var e=this,r=o.worldType,n=new Factory.Tilemap(e,"tilemap-"+r);n.addToGame(e),n.addImage("tile-"+r,"tile-"+r);var t=n.createLayer("world");n.setCollision("world",0,5e3),n.resize("world"),Container.World.tilemapLayer=t},$createPlayers:function(e){for(var r=this,a=o.game.players.height,s=o.game.players.width,l=0;l<i.players.amount;l++){var c=new Factory.Player(r,l,n+(s+70)*l,t+a);c.init(),Container.World.players.push(c)}return e(Container.World.players)},$applyEmergency:function(){var r=!1,n=this,t=function(n,t){return r=e.confirm(n),r===!0?t():void a.log("User canceled emergency action")};Emergency.$quit=function(){t("Are you sure to emergency quit the game?",function(){Emergency.$killAll(),n.exit()})},Emergency.$killAll=function(){t("Are you sure you want to kill every player?",function(){for(var e in Session){var r=Session[e];r.player().dead||r.player().die()}})},$(document).on("keypress",function(e){console.log("Keypress",e),e.ctrlKey&&25===e.which&&Emergency.$quit()})}}}(window);
!function(t,e){"use strict";new Util.Debugger("States.Over");Container.Over=function(){},Container.Over.prototype={init:function(t){this.last=t},create:function(){var t=$(".js-finished").html(),e=Util.getPlayerScoreData();$(".js-finished").html(Util.replace(t,e)),$("#"+Container.settings.render.node).fadeOut(function(){Container.game.state.start("Sync"),$(".js-finished").fadeIn()})}}}(window);
!function(t,i){"use strict";Container.Preload=function(){this.ready=!1,this.error=null,this.background=null},Container.Preload.prototype={preload:function(){Container.settings.debug&&(Container.game.time.advancedTiming=!0),this.physics.arcade.gravity.y=Container.settings.physics.arcadeGravity||200,this.ready=!0;try{this.physics.startSystem(Phaser.Physics.ARCADE)}catch(t){this.error=t}},create:function(){if(!this.ready)throw this.error;this.state.start("Game")},quit:function(){this.ready=!1}}}(window);
!function(e,n){"use strict";var r=new Util.Debugger("States.Sync");Container.Sync=function(){},Container.Sync.prototype={create:function(){var e=[],n=Object.keys(Session).length;r.log("Syncing scores over AJAX for "+n+" players ..."),async.forEachOfSeries(Session,function(n,r,o){$.ajax({type:"POST",url:"/api/save/score",data:{name:n.name,score:n.score,world:Container.settings.worldType,username:n.username},success:function(n){e.push(n),o(null)},error:function(e){o("Request failed")}})},function(o){if(o)return r["throw"](o);var s=100/n*e.length;r.log(["Scores saved for",e.length,"of",n,"players","("+s+"%)"].join(" "))})}}}(window);
!function(e,t){"use strict";var a=new HUD.Factory.Stepper($(".pregame.steps")),n=Container.settings,r=n.render;console.log("Welcome to the Pixel. Run. game by Namics AG!\n"),a.start(function(e){n.worldType=HUD.$store.world,n.currentPlayers=Util.getValues(HUD.$store.players),n.game.players.amount=n.currentPlayers.length;var t=new Phaser.Game(r.width,r.height,Phaser.CANVAS,r.node);t.state.add("Boot",Container.Boot),t.state.add("Preload",Container.Preload),t.state.add("Game",Container.Game),t.state.add("Over",Container.Over),t.state.add("Sync",Container.Sync),Container.game=t,t.state.start("Boot"),e.fadeOut(1800,function(){$(".steps").remove(),Container.$indicate.preload()})})}(window);